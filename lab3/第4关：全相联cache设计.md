### 第4关：全相联cache设计

600

- 任务要求
- 评论253

- [实验目的](https://www.educoder.net/tasks/4g2pknro8eh9#实验目的)
- [视频讲解](https://www.educoder.net/tasks/4g2pknro8eh9#视频讲解)
- [实验内容](https://www.educoder.net/tasks/4g2pknro8eh9#实验内容)
- [电路框架](https://www.educoder.net/tasks/4g2pknro8eh9#电路框架)
- [电路引脚](https://www.educoder.net/tasks/4g2pknro8eh9#电路引脚)
- [常见问题](https://www.educoder.net/tasks/4g2pknro8eh9#常见问题)
- [电路测试](https://www.educoder.net/tasks/4g2pknro8eh9#电路测试)

------

#### 实验目的

学生掌握 cache 实现的三个关键技术：数据查找，地址映射，替换算法，熟悉译码器，多路选择器，寄存器的使用，能根据不同的映射策略在 Logisim 平台中用数字逻辑电路实现 cache 机制。

#### 视频讲解





#### 实验内容

![img](https://data.educoder.net/api/attachments/719246) 上图给出了一个在 Logisim 中设计完成的 cache 系统自动测试电路，为简化实验设计，这里所有 cache 模块均为只读 cache（类似指令 cache），无写入机制。电路左侧计数器与存储器部分会在时钟驱动下逐一生成地址访问序列给 cache 模块。计数器模块的使能端受命中信号驱动，缺失时使能端无效，计数器不计数，等待系统将待请求数据所在块从二级存储器中调度到 cache 后才能继续计数。cache 与二级存储器之间通过块交换逻辑实现数据块交换，由于二级存储器相比 cache 慢很多，所以一次块交换需要多个时钟周期才能完成，cache 模块判断数据块准备好的逻辑是 blkready 信号有效，该信号有效且时钟到来时，cache 将块数据从 BlkDin 端口一次性载入到对应cache 行缓冲区中，此时 cache 数据命中，直接输出请求数据，解锁计数器使能端，继续访问下一个地址。 自动测试电路会逐一取出 trace 存储器中的主存地址去访问存储系统，并逐一将数据从 cache 模块取出送校验和计算电路计算校验和，计数器值为256时会停止电路运行，此时所有存储访问的 cache 命中率将会在右上角 LED 数码管显示。本次实验的主要任务就是设计该电路的核心模块 cache 子电路。   结合引脚功能说明，实现全相联 cache 模块，该 cache 模块共包括8个 cache 行，每个数据块包含包括4个字节共32位数据。

#### 电路框架

storage.circ 

 ![img](https://data.educoder.net/api/attachments/525191)

#### 电路引脚

| 信号         | 输入/输出 | 位宽 | 功能描述                 |
| ------------ | --------- | ---- | ------------------------ |
| Addr         | 输入      | 16   | 主存地址                 |
| BlkDataIn    | 输入      | 32   | 块数据输入               |
| BlkDataReady | 输入      | 1    | 块数据准备就绪           |
| CLK          | 输入      | 1    | 时钟输入                 |
| Miss         | 输出      | 1    | 1：数据缺失；0：数据命中 |
| DataOut      | 输出      | 8    | 数据输出                 |

#### 常见问题

![img](https://data.educoder.net/api/attachments/542022) 标准输出中访问第2块应该命中，结果实际系统没有命中，调度二级存储器进行了块交换，所以访问第2块有3次输出，分别是缺失，blkok，命中三行，这个故障说明调度算法有问题，把不应该淘汰的数据淘汰出去了。

#### 电路测试

完成设计后可以在 cache 自动测试电路中进行测试，正确结果如下： ![img](https://data.educoder.net/api/attachments/719271) 确认实验完成正确后可利用文本编辑工具打开 storage.circ，将所有文字信息复制粘贴到 Educoder平台的 storage.circ 文件中，再点击评测按钮即可进行本关测试，平台会对你设计的电路进行自动测试，为方便测试，请勿修改子电路封装，本关测试用例如下:

（这里 CNT 位第几次访问，下面第0次访问经历了3个状态，地址位0，缺失，等待从二级存储器载入数据，blkok 信号为 1，载入后，Hit 为1，见前3行）

```
CNT      Addr     BlkAddr  Offs  Hit   BlkOK Dout   CheckSum0000     0000     0000     0     0     0     00     00000000     0000     0000     0     0     1     00     00000000     0000     0000     0     1     0     00     00000001     0001     0000     1     1     0     01     00000002     0002     0000     2     1     0     02     00010003     0003     0000     3     1     0     03     00030004     0008     0002     0     0     0     00     00060004     0008     0002     0     0     1     00     00060004     0008     0002     0     1     0     08     00060005     0009     0002     1     1     0     09     000e0006     000a     0002     2     1     0     0a     00170007     000b     0002     3     1     0     0b     00210008     0010     0004     0     0     0     00     002c
```

------

**清零中的毛刺问题解决：** 清零动作改成同步清零，具体可以增加一个D触发器，将清零信号接输入，输出接异步清零，另外D触发器时钟触发方式请修改为上跳沿。

每个节拍对应各cache slot中的数据块如下,出现问题，可以参考